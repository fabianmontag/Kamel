; (executable
;  (public_name toplevel)
;  (name toplevel)
;  (libraries toplevel)
;  )

(executables
 (names toplevel)
 (public_names toplevel)
 (libraries
  js_of_ocaml-compiler
  js_of_ocaml-toplevel
  js_of_ocaml.deriving
  str
  (select
   ppx_support.ml
   from
   (js_of_ocaml-ppx -> ppx_support.enabled.ml)
   (-> ppx_support.disabled.ml)))
 (flags
  (:standard -rectypes))
 (link_flags
  (:standard -linkall))
 (modes byte js)
 (js_of_ocaml
  (sourcemap no))
 (preprocess
  (pps js_of_ocaml-ppx)))

(rule
 (targets export.txt)
 (deps
  (package js_of_ocaml-ppx)
  (package js_of_ocaml)
  (package js_of_ocaml-compiler)
  (package js_of_ocaml-toplevel))
 (action
  (run
   jsoo_listunits
   -o
   %{targets}
   stdlib
   str
   js_of_ocaml-compiler.runtime
   js_of_ocaml-ppx.as-lib
   js_of_ocaml.deriving
   js_of_ocaml
   js_of_ocaml-toplevel)))

(rule
 (targets toplevel.js)
 (action
  (run
   %{bin:js_of_ocaml}
   compile
   --pretty
   --target-env
   browser
   --export
   %{dep:export.txt}
   --toplevel
   --disable
   shortvar
   %{dep:toplevel.bc}
   -o
   %{targets})))

(alias
 (name default)
 (deps toplevel.js toplevel.bc.js))
